<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>m.ai - Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¤–</text></svg>">
</head>
<body>
    <div id="app-container"></div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =================================================================================
            // --- 1. CONFIGURATION & STATE ---
            // =================================================================================
            
            const API_BASE_URL = 'https://mgd-ai-worker.mgdwork12119241.workers.dev';
            const appContainer = document.getElementById('app-container');

            const WELCOME_MESSAGE_CONTENT = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ **m.ai**! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ø´Ø®ØµÙŠØŒ ÙˆÙ…Ù‡Ù…ØªÙŠ Ù‡ÙŠ Ø£Ù† Ø£ÙƒÙˆÙ† Ø¨ÙˆØ§Ø¨ØªÙƒ Ø¥Ù„Ù‰ Ø¹Ø§Ù„Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.\n\nØ£Ù†Ø§ Ù„Ø³Øª Ù†Ù…ÙˆØ°Ø¬Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ØŒ Ø¨Ù„ Ø£Ù†Ø§ "Ù…ÙØ¬Ù…Ù‘Ø¹" (Aggregator) Ù‚ÙˆÙŠ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ®ØµÙŠØµÙ‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø£Ù†Øª ØªØªØ­Ø¯Ø« Ù…Ø¹ÙŠ ÙÙŠ **ÙˆØ¶Ø¹ Ø§Ù„Ø¶ÙŠÙ**ØŒ ÙˆÙ‡Ùˆ ÙˆØ¶Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¨Ù‚Ø¯Ø±Ø§Øª Ù…Ø­Ø¯ÙˆØ¯Ø©.\n\n**Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø¹Ù†Ø§Ù† Ù„Ù‚Ø¯Ø±Ø§ØªÙŠ Ø§Ù„ÙƒØ§Ù…Ù„Ø©ØŒ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ²ÙˆÙŠØ¯ÙŠ Ø¨Ù…ÙØ§ØªÙŠØ­ API Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ.**\n\n---\n\n#### **Ù…Ø§Ø°Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø£Ù† ØªÙØ¹Ù„ Ø¨Ø¹Ø¯ ØªÙØ¹ÙŠÙ„ Ù…ÙØ§ØªÙŠØ­ APIØŸ**\n\nØ¨Ù…Ø¬Ø±Ø¯ Ø¥Ø¶Ø§ÙØ© Ù…ÙØ§ØªÙŠØ­ÙƒØŒ Ø³Ø£ØªØ­ÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø¹Ø¯ Ø®Ø§Ø±Ù‚ ÙŠÙ…ÙƒÙ†Ù‡:\n\n1.  **Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø£ÙØ¶Ù„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬:** Ø³Ø£Ù‚ÙˆÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ØªÙˆØ²ÙŠØ¹ Ø·Ù„Ø¨Ø§ØªÙƒ Ø¹Ù„Ù‰ Ø£Ø³Ø±Ø¹ ÙˆØ£Ù‚ÙˆÙ‰ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„ØªÙŠ ØªÙˆÙØ±Ù‡Ø§ (Ù…Ø«Ù„ Groq, Gemini, Claude, GPT-4o).\n2.  **Ø­ÙØ¸ Ù…Ø­Ø§Ø¯Ø«Ø§ØªÙƒ Ø¨Ø£Ù…Ø§Ù†:** ÙŠÙ…ÙƒÙ†Ùƒ Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ GitHub Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ù…Ø­Ø§Ø¯Ø«Ø§ØªÙƒ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù… ÙÙŠ Ù…Ø³ØªÙˆØ¯Ø¹ Ø®Ø§Øµ (Private Repository).\n3.  **ØªÙ†ÙÙŠØ° Ø§Ù„Ø£ÙØ¹Ø§Ù„ (Ù‚Ø±ÙŠØ¨Ø§Ù‹):** ÙÙŠ "ÙˆØ¶Ø¹ ÙˆÙƒÙŠÙ„ Ø§Ù„ÙØ¹Ù„"ØŒ Ø³Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø£Ø®Ø±Ù‰ Ù†ÙŠØ§Ø¨Ø© Ø¹Ù†Ùƒ.\n\n---\n\n#### **ÙƒÙŠÙ ØªÙ‚ÙˆÙ… Ø¨ØªÙØ¹ÙŠÙ„ Ù…ÙØ§ØªÙŠØ­ APIØŸ**\n\n1.  **Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ø§Ù‹ ÙÙŠ m.ai:** Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯" Ù„Ø­ÙØ¸ Ù…ÙØ§ØªÙŠØ­Ùƒ.\n2.  **Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ "Ø¥Ø¯Ø§Ø±Ø© APIs"**: Ø³ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.\n3.  **Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ API Ù…Ù† Ø£Ø­Ø¯ Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ† (Ù…Ø¹Ø¸Ù…Ù‡Ù… ÙŠÙ‚Ø¯Ù… Ø¨Ø§Ù‚Ø§Øª Ù…Ø¬Ø§Ù†ÙŠØ© Ù‚ÙˆÙŠØ©):**\n    *   **Groq (Ø§Ù„Ø£Ø³Ø±Ø¹ Ø­Ø§Ù„ÙŠØ§Ù‹):** [https://console.groq.com/keys](https://console.groq.com/keys)\n    *   **Google Gemini:** [https://makersuite.google.com/app/apikey](https://makersuite.google.com/app/apikey)\n    *   **DeepSeek:** [https://platform.deepseek.com/api_keys](https://platform.deepseek.com/api_keys)\n\n4.  **Ø£Ø¶Ù Ø§Ù„Ù…ÙØªØ§Ø­ ÙÙŠ m.ai:** Ø§Ù†Ø³Ø® Ø§Ù„Ù…ÙØªØ§Ø­ ÙˆØ£Ù„ØµÙ‚Ù‡ ÙÙŠ Ù†Ø§ÙØ°Ø© "Ø¥Ø¯Ø§Ø±Ø© APIs".\n\nØ¨Ù…Ø¬Ø±Ø¯ Ø¥Ø¶Ø§ÙØ© Ù…ÙØªØ§Ø­ ÙˆØ§Ø­Ø¯ØŒ Ø³ØªÙƒÙˆÙ† Ø¬Ø§Ù‡Ø²Ø§Ù‹ Ù„Ù„Ø§Ù†Ø·Ù„Ø§Ù‚!`;

            let state = {
                currentUser: null,
                showSidebar: false,
                conversations: [],
                currentConversationId: null,
                messages: [],
                apiKeys: [],
                isLoading: false,
                chatMode: 'chat', // 'chat' or 'action_agent'
                modals: {
                    showAuth: false,
                    isRegisterMode: false,
                    showAPIManager: false,
                }
            };

            // =================================================================================
            // --- 2. API HELPERS ---
            // =================================================================================
            const api = {
                _call: async (endpoint, method, body = null, isAuth = false) => {
                    const headers = { 'Content-Type': 'application/json' };
                    if (state.currentUser && !isAuth) {
                        headers['Authorization'] = `Bearer ${state.currentUser.userId}`;
                    }
                    
                    const options = { method, headers, body: body ? JSON.stringify(body) : null };
                    try {
                        const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error || `Ø®Ø·Ø£ ${response.status}`);
                        return data;
                    } catch (error) {
                        console.error(`API call to ${endpoint} failed:`, error);
                        alert(`ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ${error.message}`);
                        throw error;
                    }
                },
                register: (username, whatsapp) => api._call('/auth/register', 'POST', { username, whatsapp, action: 'register' }, true),
                login: (username, whatsapp) => api._call('/auth/login', 'POST', { username, whatsapp, action: 'login' }, true),
                getKeys: () => api._call('/api/keys', 'GET'),
                addKey: (keyData) => api._call('/api/keys', 'POST', keyData),
                deleteKey: (keyId) => api._call(`/api/keys/${keyId}`, 'DELETE'),
                getConversations: () => api._call('/api/conversations', 'GET'),
                getMessages: (convId) => api._call(`/api/conversations/${convId}`, 'GET'),
                sendMessage: (messages, conversationId, chatMode) => api._call('/api/chat', 'POST', { messages, conversationId, chatMode }),
            };

            // =================================================================================
            // --- 3. RENDER FUNCTIONS ---
            // =================================================================================

            function render() {
                appContainer.innerHTML = getHTML_MainInterface();
                renderMessages();
                renderConversations();
                renderModals();
                attachMainListeners();
                lucide.createIcons();
            }
            
            function renderModals() {
                document.querySelectorAll('.modal-overlay').forEach(el => el.remove());
                if (state.modals.showAuth) {
                    appContainer.insertAdjacentHTML('beforeend', getHTML_AuthModal());
                    attachAuthListeners();
                }
                if (state.modals.showAPIManager) {
                    appContainer.insertAdjacentHTML('beforeend', getHTML_APIManagerModal());
                    attachAPIManagerListeners();
                }
                lucide.createIcons();
            }
            
            function renderMessages() {
                const messagesArea = document.getElementById('messages-area');
                if (!messagesArea) return;
                if (state.messages.length === 0 && !state.isLoading) {
                    messagesArea.innerHTML = getHTML_EmptyChat();
                    return;
                }
                let messagesHTML = '<div class="messages-container">';
                state.messages.forEach(msg => { messagesHTML += getHTML_MessageBubble(msg); });
                if (state.isLoading) { messagesHTML += getHTML_ThinkingIndicator(); }
                messagesHTML += '</div>';
                messagesArea.innerHTML = messagesHTML;
                lucide.createIcons();
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }

            function renderConversations() {
                const listEl = document.getElementById('conversations-list');
                if (!listEl) return;
                if (!state.currentUser) {
                    listEl.innerHTML = '<p style="padding: 1rem; text-align: center; color: var(--gray-500);">Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ù…Ø­Ø§Ø¯Ø«Ø§ØªÙƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©.</p>';
                    return;
                }
                if (state.conversations.length === 0) {
                    listEl.innerHTML = '<p style="padding: 1rem; text-align: center; color: var(--gray-500);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ø¹Ø¯.</p>';
                    return;
                }
                listEl.innerHTML = state.conversations.map(conv => getHTML_ConversationItem(conv)).join('');
                listEl.querySelectorAll('.conv-button').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        await handleSelectConversation(e.currentTarget.dataset.convId);
                    });
                });
            }

            // =================================================================================
            // --- 4. HTML TEMPLATES ---
            // =================================================================================

            function getHTML_MainInterface() {
                const { showSidebar, currentUser, chatMode } = state;
                const userDisplayHTML = currentUser
                    ? `<span class="username">${currentUser.username}</span>`
                    : `<span class="guest">ÙˆØ¶Ø¹ Ø§Ù„Ø¶ÙŠÙ</span>`;

                return `
                    <div class="sidebar-overlay ${showSidebar ? '' : 'hidden'}"></div>
                    <div class="sidebar ${showSidebar ? '' : 'hidden'}">
                        <div class="sidebar-header">
                            <button id="new-chat-btn" class="sidebar-button new-chat-btn">
                                <i data-lucide="plus"></i> <span>Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
                            </button>
                        </div>
                        <div class="sidebar-content" id="conversations-list"></div>
                        <div class="sidebar-footer">
                            <button id="api-manager-btn" class="sidebar-button">
                                <i data-lucide="key-round"></i> <span>Ø¥Ø¯Ø§Ø±Ø© APIs</span>
                            </button>
                            ${!currentUser ? '<button id="auth-btn" class="sidebar-button"><i data-lucide="log-in"></i> <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</span></button>' : ''}
                            <div class="user-display">${userDisplayHTML}</div>
                        </div>
                    </div>
                    <div class="main-content">
                        <div class="main-header">
                            <button id="menu-btn" class="menu-button"><i data-lucide="menu"></i></button>
                            <div class="logo-header">
                                <svg width="32" height="32" viewBox="0 0 200 200">
                                    <text x="100" y="120" font-size="90" font-weight="bold" text-anchor="middle" fill="#000">m.ai</text>
                                </svg>
                            </div>
                            <div class="mode-indicator ${chatMode === 'action_agent' ? 'action-mode' : ''}">
                                ${chatMode === 'action_agent' ? '<i data-lucide="zap"></i> ÙˆØ¶Ø¹ Ø§Ù„ÙØ¹Ù„' : '<i data-lucide="message-circle"></i> ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©'}
                            </div>
                        </div>
                        <div class="messages-area" id="messages-area"></div>
                        <div class="input-area">
                            <div class="input-container">
                                <form id="message-form" class="input-form">
                                    <textarea id="message-input" class="input-textarea" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." rows="1"></textarea>
                                    <div class="input-buttons">
                                        <button type="button" id="mode-toggle-btn" class="mode-toggle-button ${chatMode === 'action_agent' ? 'active' : ''}" title="${chatMode === 'action_agent' ? 'Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©' : 'Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„ÙØ¹Ù„'}">
                                            <i data-lucide="${chatMode === 'action_agent' ? 'message-circle' : 'zap'}"></i>
                                        </button>
                                        <button id="send-btn" type="submit" class="send-button" disabled>
                                            <i data-lucide="send"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>`;
            }

            function getHTML_AuthModal() {
                const { isRegisterMode } = state.modals;
                return `
                    <div class="modal-overlay" data-modal-id="auth">
                        <div class="modal-content auth-modal">
                            <div class="modal-header">
                                <h2 class="modal-title">${isRegisterMode ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'}</h2>
                                <button class="modal-close-btn"><i data-lucide="x"></i></button>
                            </div>
                            <div class="modal-body">
                                <form id="auth-form" class="auth-form">
                                    <div class="form-group">
                                        <label for="username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                                        <input type="text" id="username" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="whatsapp">Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</label>
                                        <input type="text" id="whatsapp" required>
                                    </div>
                                    <button type="submit">${isRegisterMode ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨' : 'Ø¯Ø®ÙˆÙ„'}</button>
                                    <button type="button" class="switch-auth-mode">
                                        ${isRegisterMode ? 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†'}
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>`;
            }

            function getHTML_APIManagerModal() {
                let keysHTML = state.apiKeys.length === 0
                    ? `<p style="text-align:center; color: var(--gray-500); padding: 2rem 0;">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…ÙØ§ØªÙŠØ­ Ø¨Ø¹Ø¯.</p>`
                    : state.apiKeys.map(key => `
                        <div class="api-key-item" data-key-id="${key.id}">
                            <div class="api-key-info">
                                <div class="name">${key.custom_name}</div>
                                <div class="type">${key.key_type} - ${key.key_function}</div>
                                <div class="key-preview">${key.api_key.substring(0, 4)}...${key.api_key.slice(-4)}</div>
                            </div>
                            <div class="api-key-actions">
                                <button class="delete-btn"><i data-lucide="trash-2"></i></button>
                            </div>
                        </div>`).join('');

                return `
                    <div class="modal-overlay" data-modal-id="api-manager">
                        <div class="modal-content api-manager-modal">
                            <div class="modal-header">
                                <h2 class="modal-title">Ø¥Ø¯Ø§Ø±Ø© Ù…ÙØ§ØªÙŠØ­ APIs</h2>
                                <button class="modal-close-btn"><i data-lucide="x"></i></button>
                            </div>
                            <div class="modal-body">
                                <form id="api-key-form" class="api-key-form">
                                    <h3>Ø¥Ø¶Ø§ÙØ© Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯</h3>
                                    <div class="form-group"><input type="text" id="key-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙØªØ§Ø­ (Ù…Ø«Ø§Ù„: My Groq)" required></div>
                                    <div class="form-group"><select id="key-type" required><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option><option value="Ù…Ø¹Ø§Ù„Ø¬Ø©">Ù…Ø¹Ø§Ù„Ø¬Ø©</option><option value="ØªØ®Ø²ÙŠÙ†">ØªØ®Ø²ÙŠÙ†</option><option value="ÙØ¹Ù„">ÙØ¹Ù„</option></select></div>
                                    <div class="form-group"><input type="text" id="key-function" placeholder="Ø§Ù„ÙˆØ¸ÙŠÙØ© (Ù…Ø«Ø§Ù„: Groq, OpenAI, GitHub)" required></div>
                                    <div class="form-group"><input type="text" id="key-value" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙØªØ§Ø­ (sk-...)" required></div>
                                    <div class="form-group"><textarea id="key-prompt" placeholder="Ø´Ø®ØµÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" rows="2"></textarea></div>
                                    <button type="submit">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙØªØ§Ø­</button>
                                </form>
                                <div class="api-key-list"><h3>Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø¶Ø§ÙØ©:</h3><div id="api-keys-container">${keysHTML}</div></div>
                            </div>
                        </div>
                    </div>`;
            }
            
            function getHTML_EmptyChat() { 
                return `
                    <div class="empty-chat">
                        <div>
                            <svg width="120" height="120" viewBox="0 0 200 200" style="margin: 0 auto 1rem;">
                                <text x="100" y="120" font-size="90" font-weight="bold" text-anchor="middle" fill="#000">m.ai</text>
                            </svg>
                            <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ m.ai!</h2>
                            <p>Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ø´Ø®ØµÙŠ. Ø§Ø¨Ø¯Ø£ Ø¨ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„.</p>
                            ${!state.currentUser ? '<div class="guest-notice"><p>ğŸ’¡ <strong>Ù†ØµÙŠØ­Ø©:</strong> Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø­ÙØ¸ Ù…Ø­Ø§Ø¯Ø«Ø§ØªÙƒ ÙˆØ¥Ø¶Ø§ÙØ© Ù…ÙØ§ØªÙŠØ­ API Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ø¥Ù…ÙƒØ§Ù†ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø©</p></div>' : ''}
                        </div>
                    </div>`; 
            }
            
            function getHTML_MessageBubble(msg) { 
                const content = (msg.content || '')
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
                    
                return `
                    <div class="message-wrapper ${msg.role}">
                        ${msg.role === 'assistant' ? `
                            <div class="assistant-header">
                                <div class="assistant-avatar">
                                    <svg width="24" height="24" viewBox="0 0 200 200">
                                        <text x="100" y="120" font-size="90" font-weight="bold" text-anchor="middle" fill="#fff">m</text>
                                    </svg>
                                </div>
                                <span class="assistant-name">m.ai</span>
                            </div>
                        ` : ''}
                        <div class="message-bubble">${content}</div>
                    </div>`; 
            }
            
            function getHTML_ThinkingIndicator() { 
                return `
                    <div class="message-wrapper assistant">
                        <div class="thinking-indicator">
                            <div class="assistant-avatar">
                                <i data-lucide="loader-circle" class="thinking-spinner"></i>
                            </div>
                            <span class="assistant-name">m.ai ÙŠÙÙƒØ±...</span>
                        </div>
                    </div>`; 
            }
            
            function getHTML_ConversationItem(conv) { 
                const isActive = conv.conversation_id === state.currentConversationId;
                const shortTitle = conv.title.length > 30 ? conv.title.substring(0, 30) + '...' : conv.title;
                return `
                    <button class="sidebar-button conv-button ${isActive ? 'active' : ''}" data-conv-id="${conv.conversation_id}">
                        <div>
                            <div class="conv-title">${shortTitle}</div>
                            <div class="conv-date">${new Date(conv.updated_at).toLocaleDateString('ar')}</div>
                        </div>
                    </button>`; 
            }

            // =================================================================================
            // --- 5. EVENT HANDLERS & LOGIC ---
            // =================================================================================

            function attachMainListeners() {
                document.getElementById('menu-btn').addEventListener('click', toggleSidebar);
                document.querySelector('.sidebar-overlay').addEventListener('click', toggleSidebar);
                document.getElementById('new-chat-btn').addEventListener('click', handleNewConversation);
                
                const authBtn = document.getElementById('auth-btn');
                if (authBtn) {
                    authBtn.addEventListener('click', () => { state.modals.showAuth = true; render(); });
                }
                
                document.getElementById('api-manager-btn').addEventListener('click', openAPIManager);
                document.getElementById('mode-toggle-btn').addEventListener('click', toggleChatMode);

                const messageInput = document.getElementById('message-input');
                const sendBtn = document.getElementById('send-btn');
                messageInput.addEventListener('input', () => {
                    sendBtn.disabled = messageInput.value.trim().length === 0;
                    messageInput.style.height = 'auto';
                    messageInput.style.height = `${messageInput.scrollHeight}px`;
                });
                document.getElementById('message-form').addEventListener('submit', (e) => { e.preventDefault(); handleSendMessage(); });
            }

            function attachAuthListeners() {
                const modal = document.querySelector('[data-modal-id="auth"]');
                modal.querySelector('.modal-close-btn').addEventListener('click', () => {
                    state.modals.showAuth = false;
                    render();
                });
                modal.querySelector('.switch-auth-mode').addEventListener('click', () => {
                    state.modals.isRegisterMode = !state.modals.isRegisterMode;
                    render();
                });
                modal.querySelector('#auth-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = document.getElementById('username').value;
                    const whatsapp = document.getElementById('whatsapp').value;
                    if (!username || !whatsapp) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');

                    try {
                        const data = state.modals.isRegisterMode
                            ? await api.register(username, whatsapp)
                            : await api.login(username, whatsapp);
                        
                        if (data.success) {
                            state.currentUser = { userId: data.userId, username: data.username };
                            state.modals.showAuth = false;
                            await initializeUserSession();
                        }
                    } catch (err) { /* error already alerted by api._call */ }
                });
            }
            
            function attachAPIManagerListeners() {
                const modal = document.querySelector('[data-modal-id="api-manager"]');
                modal.querySelector('.modal-close-btn').addEventListener('click', () => {
                    state.modals.showAPIManager = false;
                    render();
                });
                modal.querySelector('#api-key-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!state.currentUser) {
                        alert('ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø­ÙØ¸ Ù…ÙØ§ØªÙŠØ­ API.');
                        state.modals.showAPIManager = false;
                        state.modals.showAuth = true;
                        render();
                        return;
                    }
                    
                    const form = e.target;
                    const keyData = {
                        custom_name: form.querySelector('#key-name').value,
                        key_type: form.querySelector('#key-type').value,
                        key_function: form.querySelector('#key-function').value,
                        api_key: form.querySelector('#key-value').value,
                        personality_prompt: form.querySelector('#key-prompt').value,
                    };
                    if (!keyData.custom_name || !keyData.key_type || !keyData.key_function || !keyData.api_key) {
                        return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©');
                    }
                    try {
                        const newKey = await api.addKey(keyData);
                        state.apiKeys.push({ ...keyData, id: newKey.id });
                        render();
                    } catch (err) { /* error already alerted */ }
                });

                modal.querySelectorAll('.api-key-item').forEach(item => {
                    item.querySelector('.delete-btn').addEventListener('click', async () => {
                        const keyId = item.dataset.keyId;
                        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ØŸ')) {
                            try {
                                await api.deleteKey(keyId);
                                state.apiKeys = state.apiKeys.filter(k => k.id != keyId);
                                render();
                            } catch (err) { /* error already alerted */ }
                        }
                    });
                });
            }

            function toggleSidebar() {
                state.showSidebar = !state.showSidebar;
                render();
            }

            function toggleChatMode() {
                state.chatMode = state.chatMode === 'chat' ? 'action_agent' : 'chat';
                render();
            }

            async function openAPIManager() {
                state.modals.showAPIManager = true;
                if (state.currentUser) {
                    try {
                        const data = await api.getKeys();
                        state.apiKeys = data.keys || [];
                    } catch (e) { /* error handled by _call */ }
                } else {
                    state.apiKeys = [];
                }
                render();
            }

            async function handleSendMessage() {
                const messageInput = document.getElementById('message-input');
                const content = messageInput.value.trim();
                if (!content || state.isLoading) return;
                
                if (!state.currentUser && state.messages.length === 0) {
                    state.messages.push({ role: 'user', content });
                    state.messages.push({ role: 'assistant', content: WELCOME_MESSAGE_CONTENT });
                    messageInput.value = '';
                    renderMessages();
                    return;
                }
                
                const userMessage = { role: 'user', content };
                state.messages.push(userMessage);
                
                if (!state.currentConversationId) {
                    state.currentConversationId = state.currentUser ? `conv_${Date.now()}` : 'guest_session';
                }
                
                state.isLoading = true;
                messageInput.value = '';
                messageInput.style.height = 'auto';
                document.getElementById('send-btn').disabled = true;
                renderMessages();

                try {
                    const assistantResponse = await api.sendMessage(state.messages, state.currentConversationId, state.chatMode);
                    state.messages.push(assistantResponse);
                } catch (error) {
                    state.messages.push({ 
                        role: 'assistant', 
                        content: `Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. ${error.message}\n\n*Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ù…ÙØ§ØªÙŠØ­ API Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©.*` 
                    });
                } finally {
                    state.isLoading = false;
                    renderMessages();
                }
            }

            async function handleNewConversation() {
                state.currentConversationId = null;
                state.messages = [];
                render();
            }

            async function handleSelectConversation(convId) {
                if (state.currentConversationId === convId || !state.currentUser) return;
                state.currentConversationId = convId;
                state.isLoading = true;
                render();
                try {
                    const data = await api.getMessages(convId);
                    state.messages = data.messages || [];
                } catch(error) { 
                    state.messages = []; 
                } finally {
                    state.isLoading = false;
                    render();
                }
            }

            async function initializeUserSession() {
                if (state.currentUser) {
                    try {
                        const data = await api.getConversations();
                        state.conversations = data.conversations || [];
                        if (state.conversations.length > 0) {
                            await handleSelectConversation(state.conversations[0].conversation_id);
                        } else {
                            await handleNewConversation();
                        }
                    } catch (error) {
                        await handleNewConversation();
                    }
                } else {
                    state.conversations = [];
                    await handleNewConversation();
                }
                render();
            }

            // =================================================================================
            // --- 6. INITIALIZATION ---
            // =================================================================================
            
            async function init() {
                await initializeUserSession();
            }

            init();
        });
    </script>
</body>
</html>
